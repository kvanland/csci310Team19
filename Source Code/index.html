<!Doctype html>
<html>

<head>
<link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet" type="text/css" />


<title> Cumulyrics </title>
</head>

<body>

  <script>
      window.fbAsyncInit = function() {
      FB.init({
        appId      : '1763484507313644',
        xfbml      : true,
        version    : 'v2.8'
      });
      FB.AppEvents.logPageView();
      };

      (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.8&appId=1763484507313644";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));


  </script>

  <link rel = "stylesheet" href = "frontEnd/styles.css">
  <div id = "titlebar">
    <h1> 
      <button id = "back" onclick = backAction()> Back </button> 
      Cumulyrics
      <button id = "home" onclick = homeAction()> <i class=material-icons "md-48">home</i> </button> 
    </h1>

  </div>
  <br><br><br><br>
  <div id = "WordCloud">
    <svg id = "wCCanvas" width = "100%" height = "0">
      
    </svg>
    <form id = "colorButtons" onchange = colorToggle()>
      <input type = "radio"  name = "Color" id="blackAndWhite" value = "Black and White"> Black and White </input> 
      <input type = "radio" name = "Color" id = "color" value = "Colorful" checked> Colorful </input>
    </form>

  </div>


  <div id = "SongList" >

  </div>


  <div id = "Lyrics">
    <svg id = "lyricsCanvas" width = "100%" height = "0">
    </svg>
  </div>


  
  <div id = "Search">
    <input id = "searchBar" type = "text" list="autoList" onchange= userTypes()></input>
    <br></br>
    <button id = "searchButton" disabled = true class = "purpleButton" onclick = searchAction()> Search </button>
    <button id = "shareButton"> Share to Facebook</button>
    <button id = "mergeButton" onclick = mergeAction() class = "purpleButton"> Add to Cloud </button>
  </div>

  <script src= "frontEnd/lib/d3/d3.js" charset="utf-8"></script>
  <script src= "frontEnd/lib/d3/d3.layout.cloud.js"></script>
  <script src= "frontEnd/d3.wordcloud.js"></script>
  <script src= "frontEnd/example.words.js"></script>
  <script src= "https://code.jquery.com/jquery-1.11.0.min.js"></script>
  <script src= "https://code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>
  <script src= "frontEnd/javascript.js"> </script> 



  <script>

  document.getElementById('shareButton').onclick = function() {

 
   var s = new XMLSerializer().serializeToString(document.getElementById("wCCanvas"));


  var img = window.btoa(s);


  var doctype = '<?xml version="1.0" standalone="no"?>'
  + '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "https://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';

// serialize our SVG XML to a string.
var source = (new XMLSerializer()).serializeToString(document.getElementById('wCCanvas'));

// create a file blob of our SVG.
var blob = new Blob([ doctype + source], { type: 'image/svg+xml;charset=utf-8' });
console.log(blob);
var url = window.URL.createObjectURL(blob);
console.log(url);
// Put the svg into an image tag so that the Canvas element can read it in.
var img = d3.select('body').append('img')
 .attr('width', 100)
 .attr('height', 100)
 .node();

var url2;
var c;
img.onload = function(){
  // Now that the image has loaded, put the image into a canvas element.
  var canvas = d3.select('body').append('canvas').node();
  canvas.width = 100;
  canvas.height = 100;
  c = canvas;
  var ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0);
  var canvasUrl = canvas.toDataURL("image/png");
  var data = canvasUrl;
  console.log(data);
  /*
    try {
        blob = dataURItoBlob(data);
    } catch (e) {
        console.log(e);
    }
    console.log("here"); */
    var encodedPng = data.substring(c.indexOf(',')+1,c.length);
    var decodedPng = Base64Binary.decode(encodedPng);
    FB.getLoginStatus(function (response) {
        console.log(response);
        if (response.status === "connected") {
            postImageToFacebook(response.authResponse.accessToken, 'img.png', 'image/png', decodedPng, 'js upload');
        } else if (response.status === "not_authorized") {
            FB.login(function (response) {
                postImageToFacebook(response.authResponse.accessToken, 'img.png', 'image/png', decodedPng, 'js upload');
            }, {scope: "publish_actions"});
        } else {
            FB.login(function (response) {
               postImageToFacebook(response.authResponse.accessToken, 'img.png', 'image/png', decodedPng, 'js upload');
            }, {scope: "publish_actions"});
        }
    });
  url2 = canvasUrl;
  var img2 = d3.select('body').append('img')
    .attr('width', 100)
    .attr('height', 100)
    .node();
  // this is now the base64 encoded version of our PNG! you could optionally
  // redirect the user to download the PNG by sending them to the url with
  // `window.location.href= canvasUrl`.
  img2.src = canvasUrl; 

}
// start loading the image.
img.src = url;
  
}


// This bit is important.  It detects/adds XMLHttpRequest.sendAsBinary.  Without this
// you cannot send image data as part of a multipart/form-data encoded request from
// Javascript.  This implementation depends on Uint8Array, so if the browser doesn't
// support either XMLHttpRequest.sendAsBinary or Uint8Array, then you will need to
// find yet another way to implement this. (This is left as an exercise for the reader,
// but if you do it, please let me know and I'll integrate it.)

// from: http://stackoverflow.com/a/5303242/945521

if ( XMLHttpRequest.prototype.sendAsBinary === undefined ) {
    XMLHttpRequest.prototype.sendAsBinary = function(string) {
        var bytes = Array.prototype.map.call(string, function(c) {
            return c.charCodeAt(0) & 0xff;
        });
        this.send(new Uint8Array(bytes).buffer);
    };
}

// This function takes an array of bytes that are the actual contents of the image file.
// In other words, if you were to look at the contents of imageData as characters, they'd
// look like the contents of a PNG or GIF or what have you.  For instance, you might use
// pnglib.js to generate a PNG and then upload it to Facebook, all from the client.
//
// Arguments:
//   authToken - the user's auth token, usually from something like authResponse.accessToken
//   filename - the filename you'd like the uploaded file to have
//   mimeType - the mime type of the file, eg: image/png
//   imageData - an array of bytes containing the image file contents
//   message - an optional message you'd like associated with the image

function PostImageToFacebook( authToken, filename, mimeType, imageData, message )
{
    // this is the multipart/form-data boundary we'll use
    var boundary = '----ThisIsTheBoundary1234567890';
    
    // let's encode our image file, which is contained in the var
    var formData = '--' + boundary + '\r\n'
    formData += 'Content-Disposition: form-data; name="source"; filename="' + filename + '"\r\n';
    formData += 'Content-Type: ' + mimeType + '\r\n\r\n';
    for ( var i = 0; i < imageData.length; ++i )
    {
        formData += String.fromCharCode( imageData[ i ] & 0xff );
    }
    formData += '\r\n';
    formData += '--' + boundary + '\r\n';
    formData += 'Content-Disposition: form-data; name="message"\r\n\r\n';
    formData += message + '\r\n'
    formData += '--' + boundary + '--\r\n';
    
    var xhr = new XMLHttpRequest();
    xhr.open( 'POST', 'https://graph.facebook.com/me/photos?access_token=' + authToken, true );
    xhr.onload = xhr.onerror = function() {
        console.log( xhr.responseText );
    };
    xhr.setRequestHeader( "Content-Type", "multipart/form-data; boundary=" + boundary );
    xhr.sendAsBinary( formData );
}

function postImageToFacebook1(token, filename, mimeType, imageData, message) {
    var fd = new FormData();
    fd.append("access_token", token);
    fd.append("source", imageData);
    fd.append("no_story", true);

    // Upload image to facebook without story(post to feed)
    $.ajax({
        url: "https://graph.facebook.com/me/photos?access_token=" + token,
        type: "POST",
        data: fd,
        processData: false,
        contentType: false,
        cache: false,
        success: function (data) {
            console.log("success: ", data);

            // Get image source url
            FB.api(
                "/" + data.id + "?fields=images",
                function (response) {
                    if (response && !response.error) {
                        //console.log(response.images[0].source);

                        // Create facebook post using image
                        FB.api(
                            "/me/feed",
                            "POST",
                            {
                                "message": "",
                                "picture": response.images[0].source,
                                "link": window.location.href,
                                "name": 'Look at the cute panda!',
                                "description": message,
                                "privacy": {
                                    value: 'SELF'
                                }
                            },
                            function (response) {
                                if (response && !response.error) {
                                    /* handle the result */
                                    console.log("Posted story to facebook");
                                    console.log(response);
                                }
                            }
                        );
                    }
                }
            );
        },
        error: function (shr, status, data) {
            console.log("error " + data + " Status " + shr.status);
        },
        complete: function (data) {
            //console.log('Post to facebook Complete');
        }
    });
}


function dataURItoBlob(dataURI) {
    var byteString = atob(dataURI.split(',')[1]);
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ab], {type: 'image/png'});
}

/*
  document.getElementById('shareButton').onclick = function() {
    FB.ui({
    method: 'share',
    href: 'https://www.photographyblogger.net/wp-content/uploads/2010/05/flower29.jpg',
    caption: 'test photo upload',
    }, function(response){});
  }
  */
  </script>

<body>

</html>
